<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Tron Lottery 抽奖游戏</title>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.2.0/dist/TronWeb.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f5f6fa; padding: 20px; }
    h1 { color: #2f3640; }
    button { padding: 10px 20px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; }
    #buyBtn { background: #44bd32; color: white; }
    #withdrawBtn { background: #273c75; color: white; }
    #refreshBtn { background: #487eb0; color: white; }
    #status { margin: 10px; font-weight: bold; }
    .card { background: white; padding: 15px; margin: 10px auto; width: 90%; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    ul { list-style: none; padding: 0; }
  </style>
</head>
<body>

  <h1>🎲 Tron Lottery 抽奖游戏</h1>
  <p>每次 10 USDT，10 人满后开奖 🎉</p>
  <div id="status">加载中...</div>

  <div class="card">
    <h3>🎟️ 奖池状态</h3>
    <p id="lotteryStatus">-</p>
    <p>当前参与人数：<span id="playerCount">0</span> / 10</p>
    <button id="buyBtn">🎫 买票参与</button>
  </div>

  <div class="card">
    <h3>💰 我的奖金</h3>
    <p><span id="myWinnings">0</span> USDT</p>
    <button id="withdrawBtn">💸 提现奖金</button>
  </div>

  <div class="card">
    <h3>👥 当前玩家</h3>
    <ul id="playersList"></ul>
  </div>

  <div class="card">
    <button id="refreshBtn">🔄 手动刷新</button>
    <p><a href="https://tronscan.org/#/contract/TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt/transactions" target="_blank">查看历史开奖记录</a></p>
  </div>

  <script>
    const CONTRACT_ADDRESS = "TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt";
    const USDT_ADDRESS = "TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf"; // 主网USDT
    const USDT_DECIMALS = 1_000_000;
    let tronWeb, contract, userAddress;

    async function init() {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        $('#status').text('请先打开 TronLink 钱包并刷新页面。');
        return;
      }
      tronWeb = window.tronWeb;
      userAddress = tronWeb.defaultAddress.base58;
      $('#status').text('钱包已连接：' + userAddress);

      try {
        const abi = await $.getJSON("https://api.tronscan.org/api/contract?contract=" + CONTRACT_ADDRESS);
        const realAbi = JSON.parse(abi.data[0].abi);
        contract = await tronWeb.contract(realAbi.entrys, CONTRACT_ADDRESS);
        loadData();
        setInterval(loadData, 10000); // 每10秒自动刷新
      } catch (e) {
        console.error(e);
        $('#status').text('❌ 合约加载失败，请检查合约地址或网络');
      }
    }

    async function loadData() {
      if (!contract) return;
      try {
        const open = await contract.lotteryOpen().call();
        const players = await contract.getPlayers().call();
        const myWin = await contract.winnings(userAddress).call();
        $('#lotteryStatus').text(open ? "开放中 ✅" : "已满，等待开奖 🎯");
        $('#playerCount').text(players.length);
        $('#myWinnings').text(Number(myWin) / USDT_DECIMALS);
        $('#playersList').html(players.map(p => `<li>${p}</li>`).join(''));
      } catch (err) {
        console.error(err);
        $('#status').text('⚠️ 数据加载失败');
      }
    }

    $('#buyBtn').on('click', async () => {
      if (!contract) return alert('合约未加载');
      try {
        $('#status').text('正在买票中...');
        const usdt = await tronWeb.contract().at(USDT_ADDRESS);
        const allowance = await usdt.allowance(userAddress, CONTRACT_ADDRESS).call();
        if (Number(allowance.remaining) < 10 * USDT_DECIMALS) {
          await usdt.approve(CONTRACT_ADDRESS, 1000 * USDT_DECIMALS).send();
          $('#status').text('已授权 USDT，再次点击买票');
          return;
        }
        await contract.enter().send({ feeLimit: 100_000_000 });
        $('#status').text('✅ 买票成功！请等待开奖');
        loadData();
      } catch (err) {
        console.error(err);
        $('#status').text('❌ 买票失败：' + (err.message || '未知错误'));
      }
    });

    $('#withdrawBtn').on('click', async () => {
      try {
        $('#status').text('正在提现...');
        await contract.withdraw().send({ feeLimit: 100_000_000 });
        $('#status').text('✅ 提现成功！');
        loadData();
      } catch (err) {
        console.error(err);
        $('#status').text('❌ 提现失败：' + (err.message || '未知错误'));
      }
    });

    $('#refreshBtn').on('click', loadData);

    window.addEventListener('load', init);
  </script>
</body>
</html>
