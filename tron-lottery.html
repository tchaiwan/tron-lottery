<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Tron Lottery æŠ½å¥–æ¸¸æˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.2.0/dist/TronWeb.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f5f6fa; padding: 20px; }
    h1 { color: #2f3640; }
    button { padding: 10px 20px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; }
    #buyBtn { background: #44bd32; color: white; }
    #withdrawBtn { background: #273c75; color: white; }
    #refreshBtn { background: #487eb0; color: white; }
    #status { margin: 10px; font-weight: bold; }
    .card { background: white; padding: 15px; margin: 10px auto; width: 90%; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    ul { list-style: none; padding: 0; }
  </style>
</head>
<body>

  <h1>ğŸ² Tron Lottery æŠ½å¥–æ¸¸æˆ</h1>
  <p>æ¯æ¬¡ 10 USDTï¼Œ10 äººæ»¡åå¼€å¥– ğŸ‰</p>
  <div id="status">åŠ è½½ä¸­...</div>

  <div class="card">
    <h3>ğŸŸï¸ å¥–æ± çŠ¶æ€</h3>
    <p id="lotteryStatus">-</p>
    <p>å½“å‰å‚ä¸äººæ•°ï¼š<span id="playerCount">0</span> / 10</p>
    <button id="buyBtn">ğŸ« ä¹°ç¥¨å‚ä¸</button>
  </div>

  <div class="card">
    <h3>ğŸ’° æˆ‘çš„å¥–é‡‘</h3>
    <p><span id="myWinnings">0</span> USDT</p>
    <button id="withdrawBtn">ğŸ’¸ æç°å¥–é‡‘</button>
  </div>

  <div class="card">
    <h3>ğŸ‘¥ å½“å‰ç©å®¶</h3>
    <ul id="playersList"></ul>
  </div>

  <div class="card">
    <button id="refreshBtn">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
    <p><a href="https://tronscan.org/#/contract/TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt/transactions" target="_blank">æŸ¥çœ‹å†å²å¼€å¥–è®°å½•</a></p>
  </div>

  <script>
    const CONTRACT_ADDRESS = "TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt";
    const USDT_ADDRESS = "TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf"; // ä¸»ç½‘USDT
    const USDT_DECIMALS = 1_000_000;
    let tronWeb, contract, userAddress;

    async function init() {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        $('#status').text('è¯·å…ˆæ‰“å¼€ TronLink é’±åŒ…å¹¶åˆ·æ–°é¡µé¢ã€‚');
        return;
      }
      tronWeb = window.tronWeb;
      userAddress = tronWeb.defaultAddress.base58;
      $('#status').text('é’±åŒ…å·²è¿æ¥ï¼š' + userAddress);

      try {
        const abi = await $.getJSON("https://api.tronscan.org/api/contract?contract=" + CONTRACT_ADDRESS);
        const realAbi = JSON.parse(abi.data[0].abi);
        contract = await tronWeb.contract(realAbi.entrys, CONTRACT_ADDRESS);
        loadData();
        setInterval(loadData, 10000); // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°
      } catch (e) {
        console.error(e);
        $('#status').text('âŒ åˆçº¦åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€æˆ–ç½‘ç»œ');
      }
    }

    async function loadData() {
      if (!contract) return;
      try {
        const open = await contract.lotteryOpen().call();
        const players = await contract.getPlayers().call();
        const myWin = await contract.winnings(userAddress).call();
        $('#lotteryStatus').text(open ? "å¼€æ”¾ä¸­ âœ…" : "å·²æ»¡ï¼Œç­‰å¾…å¼€å¥– ğŸ¯");
        $('#playerCount').text(players.length);
        $('#myWinnings').text(Number(myWin) / USDT_DECIMALS);
        $('#playersList').html(players.map(p => `<li>${p}</li>`).join(''));
      } catch (err) {
        console.error(err);
        $('#status').text('âš ï¸ æ•°æ®åŠ è½½å¤±è´¥');
      }
    }

    $('#buyBtn').on('click', async () => {
      if (!contract) return alert('åˆçº¦æœªåŠ è½½');
      try {
        $('#status').text('æ­£åœ¨ä¹°ç¥¨ä¸­...');
        const usdt = await tronWeb.contract().at(USDT_ADDRESS);
        const allowance = await usdt.allowance(userAddress, CONTRACT_ADDRESS).call();
        if (Number(allowance.remaining) < 10 * USDT_DECIMALS) {
          await usdt.approve(CONTRACT_ADDRESS, 1000 * USDT_DECIMALS).send();
          $('#status').text('å·²æˆæƒ USDTï¼Œå†æ¬¡ç‚¹å‡»ä¹°ç¥¨');
          return;
        }
        await contract.enter().send({ feeLimit: 100_000_000 });
        $('#status').text('âœ… ä¹°ç¥¨æˆåŠŸï¼è¯·ç­‰å¾…å¼€å¥–');
        loadData();
      } catch (err) {
        console.error(err);
        $('#status').text('âŒ ä¹°ç¥¨å¤±è´¥ï¼š' + (err.message || 'æœªçŸ¥é”™è¯¯'));
      }
    });

    $('#withdrawBtn').on('click', async () => {
      try {
        $('#status').text('æ­£åœ¨æç°...');
        await contract.withdraw().send({ feeLimit: 100_000_000 });
        $('#status').text('âœ… æç°æˆåŠŸï¼');
        loadData();
      } catch (err) {
        console.error(err);
        $('#status').text('âŒ æç°å¤±è´¥ï¼š' + (err.message || 'æœªçŸ¥é”™è¯¯'));
      }
    });

    $('#refreshBtn').on('click', loadData);

    window.addEventListener('load', init);
  </script>
</body>
</html>
