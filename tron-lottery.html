<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Tron Lottery æŠ½å¥–ç³»ç»Ÿ</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; padding: 20px; }
    .card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; max-width: 500px; margin: auto; }
    button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
    #status { color: green; margin-top: 10px; }
    .error { color: red; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ğŸŸ Tron Lottery æŠ½å¥–ç³»ç»Ÿ</h2>
    <p>æ¯è½®æœ€å¤š 10 ä½ç©å®¶å‚ä¸ï¼Œè‡ªåŠ¨å¼€å¥–å¹¶å‘æ”¾å¥–é‡‘ã€‚</p>
    <p>ä½ çš„åœ°å€ï¼š<span id="userAddress">æœªåŠ è½½</span></p>
    <p>å½“å‰è½®æ¬¡ï¼š<span id="round">-</span></p>
    <p>ç©å®¶äººæ•°ï¼š<span id="playerCount">-</span></p>
    <p>ä½ çš„å¥–é‡‘ï¼š<span id="reward">-</span> USDT</p>
    <button id="buy">ä¹°ç¥¨ ğŸŸ</button>
    <button id="withdraw">æç° ğŸ’°</button>
    <p id="status"></p>
    <h3>å½“å‰ç©å®¶åˆ—è¡¨</h3>
    <ul id="playerList"></ul>
    <a href="https://tronscan.org/#/address/TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt" target="_blank">ğŸ” æŸ¥çœ‹å†å²è®°å½•ï¼ˆTronScanï¼‰</a>
  </div>

  <script>
    const contractAddress = "TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt";
    const contractABI = [
      {"inputs":[{"internalType":"address","name":"_usdt","type":"address","value":"TM2NuE9gN8kiF8Wt6WEzVyt5w4v8Y8rGG3"}],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[],"name":"buyTicket","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"getPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"maxPlayers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"players","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"round","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"ticketPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"usdt","outputs":[{"internalType":"contract ITRC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"withdrawReward","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    let contract, userAddress;

    async function init() {
      if (typeof window.tronWeb === 'undefined') {
        document.getElementById('status').innerText = "âŒ è¯·å…ˆå®‰è£…å¹¶ç™»å½• TronLink é’±åŒ…";
        return;
      }

      // ç­‰å¾… TronWeb å®Œæˆåˆå§‹åŒ–
      await new Promise(r => setTimeout(r, 2000));

      userAddress = tronWeb.defaultAddress.base58;
      document.getElementById('userAddress').innerText = userAddress;

      contract = await tronWeb.contract(contractABI, contractAddress);
      document.getElementById('status').innerText = "âœ… åˆçº¦å·²åŠ è½½";

      refresh();
      setInterval(refresh, 5000); // æ¯5ç§’åˆ·æ–°
    }

    async function refresh() {
      try {
        const players = await contract.getPlayers().call();
        const round = await contract.round().call();
        const reward = await contract.rewards(userAddress).call();
        const listEl = document.getElementById('playerList');
        listEl.innerHTML = "";
        players.forEach(p => {
          const li = document.createElement('li');
          li.innerText = p;
          listEl.appendChild(li);
        });
        document.getElementById('playerCount').innerText = players.length;
        document.getElementById('round').innerText = round.toString();
        document.getElementById('reward').innerText = tronWeb.fromSun(reward.toString());
      } catch (e) {
        console.error("åˆ·æ–°å¤±è´¥", e);
      }
    }

    document.getElementById('buy').onclick = async () => {
      try {
        document.getElementById('status').innerText = "â³ äº¤æ˜“ä¸­...";
        const tx = await contract.buyTicket().send();
        document.getElementById('status').innerText = "âœ… ä¹°ç¥¨æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œï¼š" + tx;
        refresh();
      } catch (e) {
        console.error(e);
        document.getElementById('status').innerText = "âŒ ä¹°ç¥¨å¤±è´¥ï¼š" + e.message;
      }
    };

    document.getElementById('withdraw').onclick = async () => {
      try {
        document.getElementById('status').innerText = "â³ æç°ä¸­...";
        const tx = await contract.withdrawReward().send();
        document.getElementById('status').innerText = "âœ… æç°æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œï¼š" + tx;
        refresh();
      } catch (e) {
        console.error(e);
        document.getElementById('status').innerText = "âŒ æç°å¤±è´¥ï¼š" + e.message;
      }
    };

    window.onload = init;
  </script>
</body>
</html>
