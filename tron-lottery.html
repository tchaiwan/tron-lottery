<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TronLottery 前端</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  button { margin: 5px; padding: 10px 20px; }
  #log { margin-top: 20px; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: scroll; background: #f9f9f9; }
  #players { margin-top: 10px; }
</style>
</head>
<body>

<h1>TronLottery 前端</h1>

<div>
  <button id="connectWallet">连接 TronLink 钱包</button>
  <button id="buyTicket">买票 (10 USDT)</button>
  <button id="withdrawReward">提现奖金</button>
</div>

<h3>当前玩家列表:</h3>
<ul id="players"></ul>

<h3>日志:</h3>
<div id="log"></div>

<p><a href="https://tronscan.org/#/contract/TGAMQ6XhdsE7v1A9rAbsQSNQAmYDUnMPWh" target="_blank">查看合约历史记录</a></p>

<script>
let tronWeb;
let contract;
const contractAddress = "TGAMQ6XhdsE7v1A9rAbsQSNQAmYDUnMPWh";
const contractABI = [{"inputs":[{"internalType":"address","name":"_usdt","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"buyTicket","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxPlayers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"players","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"round","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ticketPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdt","outputs":[{"internalType":"contract ITRC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawReward","outputs":[],"stateMutability":"nonpayable","type":"function"}];

function log(message){
    $('#log').append(`<div>${message}</div>`);
    $('#log').scrollTop($('#log')[0].scrollHeight);
}

async function init() {
    if(window.tronWeb && window.tronWeb.ready){
        tronWeb = window.tronWeb;
        log("TronLink 已连接");
        contract = await tronWeb.contract(contractABI, contractAddress);
        startRefreshingPlayers();
    } else {
        log("请安装 TronLink 并解锁钱包");
    }
}

$('#connectWallet').click(async () => {
    await init();
});

$('#buyTicket').click(async () => {
    try {
        const tx = await contract.buyTicket().send();
        log(`买票成功，交易哈希: ${tx}`);
    } catch (err) {
        log(`买票失败: ${err}`);
    }
});

$('#withdrawReward').click(async () => {
    try {
        const tx = await contract.withdrawReward().send();
        log(`提现成功，交易哈希: ${tx}`);
    } catch (err) {
        log(`提现失败: ${err}`);
    }
});

async function refreshPlayers() {
    if(!contract) return;
    try {
        const players = await contract.getPlayers().call();
        $('#players').empty();
        if(players.length === 0){
            $('#players').append('<li>当前无玩家</li>');
        } else {
            players.forEach(p => {
                $('#players').append(`<li>${p}</li>`);
            });
        }
    } catch(err){
        log(`刷新玩家列表失败: ${err}`);
    }
}

function startRefreshingPlayers(){
    refreshPlayers();
    setInterval(refreshPlayers, 5000);
}

// 页面加载时尝试初始化
window.addEventListener('load', init);
</script>

</body>
</html>
