<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tron USDT Lottery</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tronweb/2.19.0/tronweb.min.js"></script>
</head>
<body>
<h1>Tron USDT Lottery</h1>
<p>当前轮次: <span id="round">-</span></p>
<p>当前玩家数: <span id="playerCount">-</span></p>
<button id="connectBtn">连接钱包</button>
<button id="buyBtn" disabled>买票 10 USDT</button>
<button id="refreshBtn">刷新玩家列表</button>

<div id="status"></div>

<script>
const contractAddress = "TGAMQ6XhdsE7v1A9rAbsQSNQAmYDUnMPWh"; // 主网合约地址
const tronLinkCheckInterval = 500; // ms
let contract;
let tronWebInstance;
let usdtAddress; // 在部署合约时填写的USDT地址
let ticketPrice = 10_000_000; // 10 USDT (6位小数)

// 合约 ABI
const contractABI = [ /* 你提供的 TronLottery ABI 放这里 */ ];

async function initTronWeb() {
    if (window.tronWeb && window.tronWeb.ready) {
        tronWebInstance = window.tronWeb;
        document.getElementById("status").innerText = "TronLink 已连接";
        contract = await tronWebInstance.contract(contractABI, contractAddress);
        document.getElementById("buyBtn").disabled = false;
        loadPlayers();
    } else {
        document.getElementById("status").innerText = "请安装 TronLink 或切换到主网";
        setTimeout(initTronWeb, tronLinkCheckInterval);
    }
}

// 连接钱包按钮
document.getElementById("connectBtn").onclick = async () => {
    if (!window.tronWeb) {
        alert("请安装 TronLink");
        return;
    }
    await initTronWeb();
};

// 检查 USDT 授权
async function checkAllowance() {
    const usdtABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
    const usdt = await tronWebInstance.contract(usdtABI, await contract.usdt().call());
    const allowance = await usdt.allowance(tronWebInstance.defaultAddress.base58, contractAddress).call();
    return { usdt, allowance };
}

// 买票
document.getElementById("buyBtn").onclick = async () => {
    const statusDiv = document.getElementById("status");
    statusDiv.innerText = "检查 USDT 授权中...";
    try {
        const { usdt, allowance } = await checkAllowance();
        if (allowance < ticketPrice) {
            statusDiv.innerText = "USDT 授权不足，正在授权...";
            const tx = await usdt.approve(contractAddress, ticketPrice).send();
            statusDiv.innerText = "授权成功，等待确认: " + tx;
            await new Promise(r => setTimeout(r, 5000)); // 简单等待链上确认
        }

        statusDiv.innerText = "发送买票交易...";
        const txBuy = await contract.buyTicket().send({ from: tronWebInstance.defaultAddress.base58 });
        statusDiv.innerText = "买票成功！交易哈希: " + txBuy;
        loadPlayers();
    } catch (err) {
        console.error(err);
        statusDiv.innerText = "买票失败: " + err.message;
    }
};

// 刷新玩家列表
async function loadPlayers() {
    try {
        const players = await contract.getPlayers().call();
        document.getElementById("playerCount").innerText = players.length;
        const round = await contract.round().call();
        document.getElementById("round").innerText = round;
    } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "刷新玩家列表失败: " + err.message;
    }
}

document.getElementById("refreshBtn").onclick = loadPlayers;

// 页面初始化
initTronWeb();
</script>
</body>
</html>
