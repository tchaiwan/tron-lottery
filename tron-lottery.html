<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Tron Lottery 抽奖系统</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; padding: 20px; }
    .card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; max-width: 500px; margin: auto; }
    button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
    #status { color: green; margin-top: 10px; }
    .error { color: red; }
  </style>
</head>
<body>
  <div class="card">
    <h2>🎟 Tron Lottery 抽奖系统</h2>
    <p>每轮最多 10 位玩家参与，自动开奖并发放奖金。</p>
    <p>你的地址：<span id="userAddress">未加载</span></p>
    <p>当前轮次：<span id="round">-</span></p>
    <p>玩家人数：<span id="playerCount">-</span></p>
    <p>你的奖金：<span id="reward">-</span> USDT</p>
    <button id="buy">买票 🎟</button>
    <button id="withdraw">提现 💰</button>
    <p id="status"></p>
    <h3>当前玩家列表</h3>
    <ul id="playerList"></ul>
    <a href="https://tronscan.org/#/address/TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt" target="_blank">🔍 查看历史记录（TronScan）</a>
  </div>

  <script>
    const contractAddress = "TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt";
    const contractABI = [
      {"inputs":[{"internalType":"address","name":"_usdt","type":"address","value":"TM2NuE9gN8kiF8Wt6WEzVyt5w4v8Y8rGG3"}],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[],"name":"buyTicket","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"getPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"maxPlayers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"players","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"round","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"ticketPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"usdt","outputs":[{"internalType":"contract ITRC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"withdrawReward","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    let contract, userAddress;

    async function init() {
      if (typeof window.tronWeb === 'undefined') {
        document.getElementById('status').innerText = "❌ 请先安装并登录 TronLink 钱包";
        return;
      }

      // 等待 TronWeb 完成初始化
      await new Promise(r => setTimeout(r, 2000));

      userAddress = tronWeb.defaultAddress.base58;
      document.getElementById('userAddress').innerText = userAddress;

      contract = await tronWeb.contract(contractABI, contractAddress);
      document.getElementById('status').innerText = "✅ 合约已加载";

      refresh();
      setInterval(refresh, 5000); // 每5秒刷新
    }

    async function refresh() {
      try {
        const players = await contract.getPlayers().call();
        const round = await contract.round().call();
        const reward = await contract.rewards(userAddress).call();
        const listEl = document.getElementById('playerList');
        listEl.innerHTML = "";
        players.forEach(p => {
          const li = document.createElement('li');
          li.innerText = p;
          listEl.appendChild(li);
        });
        document.getElementById('playerCount').innerText = players.length;
        document.getElementById('round').innerText = round.toString();
        document.getElementById('reward').innerText = tronWeb.fromSun(reward.toString());
      } catch (e) {
        console.error("刷新失败", e);
      }
    }

    document.getElementById('buy').onclick = async () => {
      try {
        document.getElementById('status').innerText = "⏳ 交易中...";
        const tx = await contract.buyTicket().send();
        document.getElementById('status').innerText = "✅ 买票成功！交易哈希：" + tx;
        refresh();
      } catch (e) {
        console.error(e);
        document.getElementById('status').innerText = "❌ 买票失败：" + e.message;
      }
    };

    document.getElementById('withdraw').onclick = async () => {
      try {
        document.getElementById('status').innerText = "⏳ 提现中...";
        const tx = await contract.withdrawReward().send();
        document.getElementById('status').innerText = "✅ 提现成功！交易哈希：" + tx;
        refresh();
      } catch (e) {
        console.error(e);
        document.getElementById('status').innerText = "❌ 提现失败：" + e.message;
      }
    };

    window.onload = init;
  </script>
</body>
</html>
