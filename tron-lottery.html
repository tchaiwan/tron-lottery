<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TronLottery</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background-color: #f0f2f5; }
  button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  #log { margin-top: 20px; background: #fff; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
  h1 { color: #333; }
  #players { margin: 10px 0; }
</style>
</head>
<body>
<h1>TronLottery</h1>

<button id="connectBtn">连接钱包</button>
<div>
  <button id="buyTicketBtn">买票 (10 USDT)</button>
  <button id="withdrawBtn">提现奖金</button>
</div>

<h3>当前参与玩家:</h3>
<div id="players">暂无玩家</div>

<h3>操作日志:</h3>
<div id="log"></div>

<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
<script>
let tronWeb;
let walletAddress;
const TRON_LOTTERY_ADDRESS = "你的TronLottery合约地址"; // 替换为你的合约地址
const USDT_ADDRESS = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj"; // 主网USDT
const LOTTERY_ABI = [{"inputs":[{"internalType":"address","name":"_usdt","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"buyTicket","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxPlayers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"players","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"round","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ticketPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdt","outputs":[{"internalType":"contract ITRC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawReward","outputs":[],"stateMutability":"nonpayable","type":"function"}];

const USDT_ABI = [
  {"constant":true,"inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"constant":true,"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"constant":false,"inputs":[{"name":"recipient","type":"address"},{"name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"constant":false,"inputs":[{"name":"sender","type":"address"},{"name":"recipient","type":"address"},{"name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}
];

let lotteryContract;
let usdtContract;

function log(msg){
  const logDiv = document.getElementById('log');
  logDiv.innerHTML += `<div>${msg}</div>`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

async function initTronWeb() {
  if(window.tronWeb && window.tronWeb.ready){
    tronWeb = window.tronWeb;
    walletAddress = tronWeb.defaultAddress.base58;
    log(`钱包已连接: ${walletAddress}`);

    lotteryContract = await tronWeb.contract(LOTTERY_ABI, TRON_LOTTERY_ADDRESS);
    usdtContract = await tronWeb.contract(USDT_ABI, USDT_ADDRESS);
    refreshPlayers();
  } else {
    log("请安装 TronLink 或刷新页面后重试");
  }
}

async function buyTicket() {
  try{
    if(!walletAddress) { log("钱包未连接"); return; }

    const allowance = await usdtContract.allowance(walletAddress, TRON_LOTTERY_ADDRESS).call();
    const ticketPrice = await lotteryContract.ticketPrice().call();

    if(Number(allowance) < Number(ticketPrice)){
      log("授权 USDT...");
      await usdtContract.approve(TRON_LOTTERY_ADDRESS, ticketPrice).send();
      log("授权完成");
    }

    log("买票中...");
    await lotteryContract.buyTicket().send();
    log("买票成功");
    refreshPlayers();
  } catch(e){
    log("买票失败: " + e);
  }
}

async function withdrawReward() {
  try{
    await lotteryContract.withdrawReward().send();
    log("提现成功");
  } catch(e){
    log("提现失败: " + e);
  }
}

async function refreshPlayers() {
  try{
    const players = await lotteryContract.getPlayers().call();
    const playersDiv = document.getElementById('players');
    playersDiv.innerHTML = players.length ? players.join('<br>') : "暂无玩家";
  } catch(e){
    log("刷新玩家列表失败: " + e);
  }
}

document.getElementById('connectBtn').onclick = initTronWeb;
document.getElementById('buyTicketBtn').onclick = buyTicket;
document.getElementById('withdrawBtn').onclick = withdrawReward;

// 自动每5秒刷新玩家列表
setInterval(refreshPlayers, 5000);
</script>
</body>
</html>
