<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>TronLottery 前端</title>
<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
</head>
<body>
<h1>Tron USDT 抽奖游戏</h1>
<button id="connectWallet">连接钱包</button>
<button id="approveBtn">授权 USDT</button>
<button id="buyTicketBtn">买票</button>
<button id="withdrawBtn">提现奖金</button>
<h3>当前参与玩家:</h3>
<ul id="playersList"></ul>
<h3>操作日志:</h3>
<div id="log"></div>

<script>
const contractAddress = "TGAMQ6XhdsE7v1A9rAbsQSNQAmYDUnMPWh"; // 你的 TronLottery 合约
const usdtAddress = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj"; // 主网 USDT
let tronWeb;
let lotteryContract;
let usdtContract;

function log(message) {
    const logDiv = document.getElementById("log");
    const p = document.createElement("p");
    p.textContent = message;
    logDiv.prepend(p);
}

// 初始化 TronWeb
async function initTronWeb() {
    if (window.tronWeb && window.tronWeb.ready) {
        tronWeb = window.tronWeb;
        log("TronWeb 初始化完成，钱包地址: " + tronWeb.defaultAddress.base58);

        // 合约对象
        lotteryContract = await tronWeb.contract(
            // 你的 TronLottery ABI
            [{"inputs":[{"internalType":"address","name":"_usdt","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"buyTicket","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxPlayers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"players","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"round","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ticketPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdt","outputs":[{"internalType":"contract ITRC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawReward","outputs":[],"stateMutability":"nonpayable","type":"function"}], 
            contractAddress
        );

        // TRC20 USDT 合约对象
        usdtContract = await tronWeb.contract(
            [{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}],
            usdtAddress
        );

        refreshPlayers();
    } else {
        log("请安装 TronLink 或在手机端打开 TronLink 浏览器");
    }
}

document.getElementById("connectWallet").onclick = initTronWeb;

// 授权 USDT
document.getElementById("approveBtn").onclick = async () => {
    try {
        const amount = 1000 * 1e6; // 授权 1000 USDT
        const tx = await usdtContract.methods.approve(contractAddress, amount).send({
            feeLimit: 100_000_000,
            callValue: 0,
        });
        log("授权成功，交易哈希: " + tx);
    } catch (err) {
        log("授权失败: " + err);
    }
};

// 买票
document.getElementById("buyTicketBtn").onclick = async () => {
    try {
        const tx = await lotteryContract.methods.buyTicket().send({
            feeLimit: 100_000_000,
            callValue: 0,
        });
        log("买票成功，交易哈希: " + tx);
        refreshPlayers();
    } catch (err) {
        log("买票失败: " + err);
    }
};

// 提现奖金
document.getElementById("withdrawBtn").onclick = async () => {
    try {
        const tx = await lotteryContract.methods.withdrawReward().send({
            feeLimit: 100_000_000,
            callValue: 0,
        });
        log("提现成功，交易哈希: " + tx);
    } catch (err) {
        log("提现失败: " + err);
    }
};

// 刷新玩家列表
async function refreshPlayers() {
    try {
        const players = await lotteryContract.methods.getPlayers().call();
        const ul = document.getElementById("playersList");
        ul.innerHTML = "";
        players.forEach(p => {
            const li = document.createElement("li");
            li.textContent = p;
            ul.appendChild(li);
        });
        log("玩家列表刷新成功");
    } catch (err) {
        log("刷新玩家列表失败: " + err);
    }
}

// 自动刷新每 5 秒
setInterval(refreshPlayers, 5000);
</script>
</body>
</html>
