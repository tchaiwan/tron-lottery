<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tron Lottery Game - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background: #f4f4f4; }
    h2 { text-align:center; color: #333; padding: 10px 0; }
    .topbar {
      position: sticky; top:0; background:#e7f3fe; border-left:5px solid #2196F3; padding:10px;
      font-size:16px; z-index:100;
    }
    button { margin:5px 0; padding:12px; width:100%; font-size:16px; cursor:pointer; border:none; border-radius:5px; background:#2196F3; color:white; }
    button:disabled { background:#ccc; cursor:not-allowed; }
    #output { margin:10px; background:#fff; padding:10px; border:1px solid #ccc; max-height:calc(100vh - 180px); overflow-y:auto; }
    table { border-collapse: collapse; width:100%; min-width: 400px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; font-size:14px; word-break: break-all; }
    th { background:#eee; }
  </style>
</head>
<body>
  <h2>ğŸ² Tron Lottery Game</h2>
  <div class="topbar" id="roundInfo">å½“å‰è½®æ•°ï¼š- &nbsp;&nbsp; å½“å‰å¥–æ± ï¼š- USDT</div>

  <div style="padding:0 10px;">
    <button id="buyBtn" onclick="buyTicket()">ä¹°ç¥¨ (10 USDT)</button>
    <button onclick="withdrawReward()">æç°å¥–é‡‘</button>
    <button onclick="refreshAll()">åˆ·æ–°ç©å®¶å’Œå†å²å¼€å¥–</button>
  </div>

  <div id="output"></div>

  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
  <script>
    const CONTRACT_ADDRESS = "TMjrX4nZj1aeGnzaCwJiSFJxpKWMuwG1FZ";
    const TICKET_PRICE = 10;

    if(!window.tronWeb || !window.tronWeb.ready){
      document.getElementById('output').innerText = "è¯·å®‰è£… TronLink å¹¶ç™»å½•é’±åŒ…";
    }

    function shortenAddress(addr){
      return addr.slice(0,6)+'â€¦'+addr.slice(-4);
    }

    async function getContract(){ return await tronWeb.contract().at(CONTRACT_ADDRESS); }

    async function buyTicket(){
      try{
        const contract = await getContract();
        const tx = await contract.buyTicket().send();
        document.getElementById("output").innerText = "ä¹°ç¥¨æˆåŠŸï¼\näº¤æ˜“ID: " + tx;
        await refreshAll();
      }catch(err){
        document.getElementById("output").innerText = "ä¹°ç¥¨å¤±è´¥:\n" + err;
      }
    }

    async function withdrawReward(){
      try{
        const contract = await getContract();
        const tx = await contract.withdrawReward().send();
        document.getElementById("output").innerText = "æç°æˆåŠŸï¼\näº¤æ˜“ID: " + tx;
        await refreshAll();
      }catch(err){
        document.getElementById("output").innerText = "æç°å¤±è´¥:\n" + err;
      }
    }

    async function refreshAll(){
      try{
        const contract = await getContract();
        const players = await contract.getPlayers().call();
        const round = await contract.round().call();

        let totalCollected = players.length * TICKET_PRICE;
        let totalRewards = 0;
        for(let i=0;i<players.length;i++){
          const reward = await contract.rewards(players[i]).call();
          totalRewards += parseInt(reward)/1e6;
        }
        const remainingPool = totalCollected - totalRewards;

        document.getElementById("roundInfo").innerHTML = `å½“å‰è½®æ•°ï¼š${round} &nbsp;&nbsp; å½“å‰å¥–æ± ï¼š${remainingPool} USDT`;

        const buyBtn = document.getElementById("buyBtn");
        if(players.length >= 10){ buyBtn.disabled = true; buyBtn.innerText = "äººæ•°å·²æ»¡"; }
        else { buyBtn.disabled=false; buyBtn.innerText="ä¹°ç¥¨ (10 USDT)"; }

        let html="<h3>å½“å‰å‚ä¸ç©å®¶å’Œå¥–é‡‘</h3>";
        if(players.length===0){ html+="<p>æš‚æ— ç©å®¶</p>"; }
        else{
          html+="<div style='overflow-x:auto'><table><tr><th>ç©å®¶</th><th>å¥–é‡‘(USDT)</th></tr>";
          for(let i=0;i<players.length;i++){
            const reward = await contract.rewards(players[i]).call();
            html+=`<tr><td>${shortenAddress(players[i])}</td><td>${reward/1e6}</td></tr>`;
          }
          html+="</table></div>";
        }

        html+="<h3>å†å²å¼€å¥–è®°å½•</h3>";
        const history = await contract.getHistory().call();
        if(history.length===0){ html+="<p>æš‚æ— å†å²å¼€å¥–</p>"; }
        else{
          for(let i=0;i<history.length;i++){
            html+=`<p>ç¬¬${history[i].round}è½®ä¸­å¥–ç©å®¶å’Œé‡‘é¢:</p>`;
            html+="<div style='overflow-x:auto'><table><tr><th>ç©å®¶</th><th>é‡‘é¢(USDT)</th></tr>";
            for(let j=0;j<history[i].winners.length;j++){
              html+=`<tr><td>${shortenAddress(history[i].winners[j])}</td><td>${history[i].amounts[j]/1e6}</td></tr>`;
            }
            html+="</table></div>";
          }
        }

        document.getElementById("output").innerHTML = html;

      }catch(err){
        document.getElementById("output").innerText = "åˆ·æ–°å¤±è´¥:\n"+err;
      }
    }

    setInterval(refreshAll,15000);
    refreshAll();
  </script>
</body>
</html>
