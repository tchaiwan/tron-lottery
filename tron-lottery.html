<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TronLottery</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button { padding: 10px 20px; margin: 5px; cursor: pointer; }
#players { margin-top: 10px; }
</style>
</head>
<body>
<h2>Tron USDT Lottery</h2>
<p>每轮 5 人满自动开奖，奖金自动发放</p>

<button id="connectWallet">连接钱包</button>
<button id="buyTicket" disabled>买票 10 USDT</button>
<button id="withdrawReward" disabled>提现奖金</button>
<div id="status"></div>

<h3>当前玩家列表</h3>
<ul id="players"></ul>

<p><a href="https://tronscan.org/#/contracts" target="_blank">查询历史开奖</a></p>

<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
<script>
// 替换为你的合约地址和 ABI
const CONTRACT_ADDRESS = "TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt";
const CONTRACT_ABI = [ /* 在这里粘贴你的 ABI */ ];

let tronWeb, contract, userAddress;

async function init() {
    if (window.tronWeb && tronWeb.ready) {
        tronWeb = window.tronWeb;
        userAddress = tronWeb.defaultAddress.base58;
        contract = await tronWeb.contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        document.getElementById("status").innerText = "钱包已连接: " + userAddress;
        document.getElementById("buyTicket").disabled = false;
        document.getElementById("withdrawReward").disabled = false;
        refreshPlayers();
        setInterval(refreshPlayers, 5000); // 每5秒刷新玩家列表
    } else {
        document.getElementById("status").innerText = "请安装并登录 TronLink 钱包";
        setTimeout(init, 1000);
    }
}

// 检查并授权 USDT
async function ensureAllowance() {
    const usdtAddress = await contract.usdt().call();
    const usdtContract = await tronWeb.contract([
        { "constant":true,"inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"type":"function"},
        { "constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"}
    ], usdtAddress);

    const allowance = await usdtContract.allowance(userAddress, CONTRACT_ADDRESS).call();
    const ticketPrice = await contract.ticketPrice().call();
    if (parseInt(allowance) < parseInt(ticketPrice)) {
        await usdtContract.approve(CONTRACT_ADDRESS, ticketPrice).send();
    }
}

// 买票
async function buyTicket() {
    try {
        await ensureAllowance();
        await contract.buyTicket().send({ from: userAddress });
        alert("买票成功！");
        refreshPlayers();
    } catch (err) {
        console.error(err);
        alert("买票失败: " + err.message);
    }
}

// 提现奖励
async function withdrawReward() {
    try {
        await contract.withdrawReward().send({ from: userAddress });
        alert("提现成功！");
        refreshPlayers();
    } catch (err) {
        console.error(err);
        alert("提现失败: " + err.message);
    }
}

// 刷新玩家列表
async function refreshPlayers() {
    try {
        const players = await contract.getPlayers().call();
        const ul = document.getElementById("players");
        ul.innerHTML = "";
        for (let p of players) {
            const li = document.createElement("li");
            li.innerText = p;
            ul.appendChild(li);
        }
    } catch (err) {
        console.error(err);
    }
}

document.getElementById("connectWallet").onclick = init;
document.getElementById("buyTicket").onclick = buyTicket;
document.getElementById("withdrawReward").onclick = withdrawReward;

</script>
</body>
</html>
