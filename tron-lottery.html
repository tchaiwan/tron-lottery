<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tron Lottery Game - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background: #f4f4f4; }
    h2 { text-align:center; color: #333; padding: 10px 0; }
    .topbar {
      position: sticky; top:0; background:#e7f3fe; border-left:5px solid #2196F3; padding:10px;
      font-size:16px; z-index:100;
    }
    button { margin:5px 0; padding:12px; width:100%; font-size:16px; cursor:pointer; border:none; border-radius:5px; background:#2196F3; color:white; }
    button:disabled { background:#ccc; cursor:not-allowed; }
    #output { margin:10px; background:#fff; padding:10px; border:1px solid #ccc; max-height:calc(100vh - 180px); overflow-y:auto; }
    table { border-collapse: collapse; width:100%; min-width: 400px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; font-size:14px; word-break: break-all; }
    th { background:#eee; }
    .link { color:#2196F3; text-decoration:underline; cursor:pointer; margin-top:10px; display:inline-block; }
  </style>
</head>
<body>
  <h2>ğŸ² Tron Lottery Game</h2>
  <div class="topbar" id="roundInfo">è½®æ•°ï¼š- &nbsp;&nbsp; å½“å‰ç©å®¶æ•°ï¼š- / 10 &nbsp;&nbsp; å‰©ä½™ç¥¨æ•°ï¼š- &nbsp;&nbsp; å¥–æ± é‡‘é¢ï¼š- USDT</div>

  <div style="padding:0 10px;">
    <button id="buyBtn" onclick="buyTicket()">ä¹°ç¥¨ (10 USDT)</button>
    <button onclick="withdrawReward()">æç°å¥–é‡‘</button>
    <button onclick="refreshAll()">åˆ·æ–°ç©å®¶å’Œå¥–é‡‘</button>
    <div class="link" onclick="viewHistory()">æŸ¥çœ‹å†å²è®°å½•</div>
  </div>

  <div id="output"></div>

  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
  <script>
    const CONTRACT_ADDRESS = "TMjrX4nZj1aeGnzaCwJiSFJxpKWMuwG1FZ";
    const TICKET_PRICE = 10;
    const MAX_PLAYERS = 10;

    let currentRound = 1; // å‰ç«¯è½®æ•°è®¡æ•°

    if(!window.tronWeb || !window.tronWeb.ready){
      document.getElementById('output').innerText = "è¯·å®‰è£… TronLink å¹¶ç™»å½•é’±åŒ…";
    }

    function shortenAddress(addr){
      return addr.slice(0,6)+'â€¦'+addr.slice(-4);
    }

    async function getContract(){ 
      return await tronWeb.contract().at(CONTRACT_ADDRESS); 
    }

    async function buyTicket(){
      try{
        const contract = await getContract();
        const tx = await contract.enter().send();
        alert("ä¹°ç¥¨æˆåŠŸï¼äº¤æ˜“ID:\n" + tx);
        await refreshAll();
      } catch(err){
        console.error(err);
        // æå–é”™è¯¯ä¿¡æ¯
        let message = "ä¹°ç¥¨å¤±è´¥ï¼ŒåŸå› æœªçŸ¥";
        if(err && err.data && err.data.message){
          message = err.data.message;
        } else if(err && err.message){
          message = err.message;
        } else if(err && err.constructor===String){
          message = err;
        }

        // åˆ¤æ–­å¸¸è§é”™è¯¯
        if(message.includes("Already entered")){
          message = "ä¹°ç¥¨å¤±è´¥ï¼šä½ æœ¬è½®å·²è´­ä¹°è¿‡ç¥¨";
        } else if(message.includes("Lottery is full")){
          message = "ä¹°ç¥¨å¤±è´¥ï¼šæœ¬è½®äººæ•°å·²æ»¡ï¼Œè¯·ç­‰å¾…ä¸‹ä¸€è½®";
        } else if(message.includes("transferFrom")){
          message = "ä¹°ç¥¨å¤±è´¥ï¼šUSDTä½™é¢ä¸è¶³æˆ–æœªæˆæƒåˆçº¦";
        }

        alert(message);
      }
    }

    async function withdrawReward(){
      try{
        const contract = await getContract();
        const tx = await contract.withdraw().send();
        alert("æç°æˆåŠŸï¼äº¤æ˜“ID:\n" + tx);
        await refreshAll();
      }catch(err){
        console.error(err);
        alert("æç°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯");
      }
    }

    async function refreshAll(){
      try{
        const contract = await getContract();
        const players = await contract.getPlayers().call();

        const totalCollected = players.length * TICKET_PRICE;
        const remainingTickets = MAX_PLAYERS - players.length;

        document.getElementById("roundInfo").innerHTML = 
          `è½®æ•°ï¼š${currentRound} &nbsp;&nbsp; å½“å‰ç©å®¶æ•°ï¼š${players.length} / ${MAX_PLAYERS} &nbsp;&nbsp; å‰©ä½™ç¥¨æ•°ï¼š${remainingTickets} &nbsp;&nbsp; å¥–æ± é‡‘é¢ï¼š${totalCollected} USDT`;

        const buyBtn = document.getElementById("buyBtn");
        if(players.length >= MAX_PLAYERS){ 
          buyBtn.disabled = true; 
          buyBtn.innerText = "äººæ•°å·²æ»¡ï¼Œæœ¬è½®åœæ­¢ä¹°ç¥¨"; 
        } else { 
          buyBtn.disabled=false; 
          buyBtn.innerText = `ä¹°ç¥¨ (å‰©ä½™ ${remainingTickets} å¼ )`; 
        }

        let html="<h3>å½“å‰å‚ä¸ç©å®¶å’Œå¥–é‡‘</h3>";
        if(players.length===0){ html+="<p>æš‚æ— ç©å®¶</p>"; }
        else{
          html+="<div style='overflow-x:auto'><table><tr><th>ç©å®¶</th><th>å¥–é‡‘(USDT)</th></tr>";
          for(let i=0;i<players.length;i++){
            const reward = await contract.winnings(players[i]).call();
            html+=`<tr><td>${shortenAddress(players[i])}</td><td>${reward/1e6}</td></tr>`;
          }
          html+="</table></div>";
        }
        document.getElementById("output").innerHTML = html;

        if(players.length >= MAX_PLAYERS){
          currentRound++;
        }

      }catch(err){
        console.error(err);
        document.getElementById("output").innerText = "åˆ·æ–°å¤±è´¥:\n"+err;
      }
    }

    function viewHistory(){
      const url = `https://tronscan.org/#/contract/${CONTRACT_ADDRESS}/transactions`;
      window.open(url, "_blank");
    }

    // æ¯3ç§’è‡ªåŠ¨åˆ·æ–°
    setInterval(refreshAll,3000);
    refreshAll();
  </script>
</body>
</html>
