<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Tron USDT Lottery</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button { padding: 10px 20px; margin: 5px; cursor: pointer; }
#players { margin-top: 10px; }
#status { margin-top: 10px; color: blue; }
</style>
</head>
<body>
<h2>Tron USDT Lottery</h2>
<p>每轮 5 人满自动开奖，奖金自动发放</p>

<button id="connectWallet">连接钱包</button>
<button id="buyTicket" disabled>买票 10 USDT</button>
<button id="withdrawReward" disabled>提现奖金</button>

<div id="status">状态提示将在这里显示</div>

<h3>当前玩家列表</h3>
<ul id="players"></ul>

<p><a href="https://tronscan.org/#/contracts" target="_blank">查询历史开奖</a></p>

<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
<script>
// 填写你的合约地址和 USDT 地址
const CONTRACT_ADDRESS = "TAUUHuWB3bk4BN7otRurVmuXhjpGgbmKvt";
const USDT_ADDRESS = "TM2NuE9gN8kiF8Wt6WEzVyt5w4v8Y8rGG3"; // TRC20 USDT
const CONTRACT_ABI = [ /* 这里填你的合约 ABI */ ];

let tronWeb, contract, userAddress;

function updateStatus(msg, isError=false) {
    const statusDiv = document.getElementById("status");
    statusDiv.innerText = msg;
    statusDiv.style.color = isError ? "red" : "blue";
}

// 初始化 TronWeb
async function initTronWeb() {
    updateStatus("检测 TronLink 钱包中...");
    const detectInterval = setInterval(async () => {
        if (window.tronWeb && window.tronWeb.ready) {
            clearInterval(detectInterval);
            tronWeb = window.tronWeb;
            userAddress = tronWeb.defaultAddress.base58;
            updateStatus("钱包已连接: " + userAddress);

            document.getElementById("buyTicket").disabled = false;
            document.getElementById("withdrawReward").disabled = false;

            try {
                contract = await tronWeb.contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                updateStatus("合约加载成功: " + CONTRACT_ADDRESS);
                refreshPlayers();
                setInterval(refreshPlayers, 5000);
            } catch (err) {
                console.error(err);
                updateStatus("合约加载失败: " + err.message, true);
            }
        }
    }, 1000);
}

// 自动授权 TRC20 USDT
async function approveUSDT(amount) {
    try {
        const usdtContract = await tronWeb.contract().at(USDT_ADDRESS);
        const allowance = await usdtContract.allowance(userAddress, CONTRACT_ADDRESS).call();
        if (parseInt(allowance) >= amount) return true;

        updateStatus("正在授权 USDT，请在 TronLink 确认...");
        await usdtContract.approve(CONTRACT_ADDRESS, amount).send({from: userAddress});
        updateStatus("授权成功！");
        return true;
    } catch (err) {
        console.error(err);
        updateStatus("USDT 授权失败: " + err.message, true);
        return false;
    }
}

// 买票
async function buyTicket() {
    const ticketPrice = 10 * 1e6;
    const approved = await approveUSDT(ticketPrice);
    if (!approved) return;

    updateStatus("正在买票，请在 TronLink 确认交易...");
    try {
        await contract.buyTicket().send({from: userAddress});
        updateStatus("买票成功！");
        refreshPlayers();
    } catch (err) {
        console.error(err);
        updateStatus("买票失败: " + err.message, true);
    }
}

// 提现奖励
async function withdrawReward() {
    updateStatus("正在提现，请在 TronLink 确认交易...");
    try {
        await contract.withdrawReward().send({from: userAddress});
        updateStatus("提现成功！");
        refreshPlayers();
    } catch (err) {
        console.error(err);
        updateStatus("提现失败: " + err.message, true);
    }
}

// 刷新玩家列表
async function refreshPlayers() {
    try {
        const players = await contract.getPlayers().call();
        const ul = document.getElementById("players");
        ul.innerHTML = "";
        for (let p of players) {
            const li = document.createElement("li");
            li.innerText = p;
            ul.appendChild(li);
        }
    } catch (err) {
        console.error(err);
        updateStatus("刷新玩家列表失败: " + err.message, true);
    }
}

document.getElementById("connectWallet").onclick = initTronWeb;
document.getElementById("buyTicket").onclick = buyTicket;
document.getElementById("withdrawReward").onclick = withdrawReward;
</script>
</body>
</html>
